---
# ========================================
# cPanel Git Deployment Configuration - VERSIUNE COMPLETÄ‚
# ========================================

deployment:
  tasks:
    # ----------------------------------------
    # 1. Definire variabile de mediu pentru siguranÈ›Äƒ
    # ----------------------------------------
    - export REPOPATH=$HOME/repositories/webgsm/app/public/wp-content
    - export SITEPATH=$HOME/public_html/test/wp-content
    - export TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    
    # ----------------------------------------
    # 2. Backup de siguranÈ›Äƒ (Complet)
    # ----------------------------------------
    - echo "ğŸ’¾ Backup-ing /test/ site content..."
    - mkdir -p $HOME/backups/test_site
    - tar -czf $HOME/backups/test_site/full-backup-$TIMESTAMP.tar.gz $SITEPATH 2>/dev/null || true

    # ----------------------------------------
    # 3. Asigurare directoare destinaÈ›ie (Prevenire erori cp)
    # ----------------------------------------
    - mkdir -p $SITEPATH/plugins
    - mkdir -p $SITEPATH/themes

    # ----------------------------------------
    # 4. Deploy PLUGINS (Cale completÄƒ din repo)
    # ----------------------------------------
    - echo "ğŸ”„ Deploying custom plugins..."
    
    # Folosim rsync sau cp -rf. cp -rf este mai simplu Ã®n cPanel.
    - /bin/cp -rf $REPOPATH/plugins/webgsm-b2b-pricing $SITEPATH/plugins/
    - /bin/cp -rf $REPOPATH/plugins/webgsm-checkout-pro $SITEPATH/plugins/
    - /bin/cp -rf $REPOPATH/plugins/webgsm-customer-tiers $SITEPATH/plugins/ 2>/dev/null || true
    
    # ----------------------------------------
    # 5. Deploy THEME (Cale completÄƒ din repo)
    # ----------------------------------------
    - echo "ğŸ”„ Deploying child theme..."
    - /bin/cp -rf $REPOPATH/themes/martfury-child $SITEPATH/themes/

    # ----------------------------------------
    # 6. Permisiuni È™i CurÄƒÈ›enie (Vital pentru WordPress)
    # ----------------------------------------
    - echo "ğŸ”’ Setting permissions and cleaning..."
    - find $SITEPATH/plugins/webgsm-* -type d -exec chmod 755 {} \;
    - find $SITEPATH/plugins/webgsm-* -type f -exec chmod 644 {} \;
    - find $SITEPATH/themes/martfury-child -type d -exec chmod 755 {} \;
    - find $SITEPATH/themes/martfury-child -type f -exec chmod 644 {} \;
    
    # È˜terge fiÈ™ierele de sistem Git/IDE care pot apÄƒrea din greÈ™ealÄƒ
    - find $SITEPATH -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
    - find $SITEPATH -name ".DS_Store" -type f -delete 2>/dev/null || true

    # ----------------------------------------
    # 7. Finalizare: Cache & Trigger
    # ----------------------------------------
    - echo "ğŸ—‘ï¸ Flushing cache..."
    - rm -rf $SITEPATH/cache/* 2>/dev/null || true
    # Trigger pentru WordPress sÄƒ vadÄƒ schimbarea plugin-ului
    - touch $SITEPATH/plugins/webgsm-b2b-pricing/webgsm-b2b-pricing.php
    
    - echo "ğŸš€ [SUCCESS] Deployment to /public_html/test/ finished!"